<!DOCTYPE html>
<html>
<head>
	<title>管理菜色</title>
</head>
<body>
	<%- include('../function') %>
	<div class="col py-3">
	<nav aria-label="breadcrumb">
		<ol class="breadcrumb">
		<li class="breadcrumb-item me-2"><img src="/menu.png" width="16" height="16"></li>
		<li class="breadcrumb-item"><a href="/main">首頁</a></li>
		<li class="breadcrumb-item"><a href="/food">管理菜色</a></li>
		<li class="breadcrumb-item active" aria-current="page">新增菜色資料</li>
		</ol>
	</nav>
	<div class="container mt-5">
		<div class="row justify-content-center">
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<strong>新增菜色資料</strong>
					<button type="button" class="btn btn-primary btn-sm float-end" onclick="addField()">新增描述欄位</button>
				</div>
				<div class="card-body">
				<form id="foodForm">
				<div class="row mb-3">
				  <div class="col-6">
				    <label class="form-label">名稱</label>
				    <input type="text" class="form-control" name="ds_name" id="ds_name" required>
				  </div>
				  <div class="col-6">
					  <div><label class="form-label">葷素</label></div>
					  <div class="form-check form-check-inline">
						  <input class="form-check-input"type="radio" name="food_type" id="food_type" value="葷" checked required>
						  <label class="form-check-label">葷</label>
					  </div>
					  <div class="form-check form-check-inline">
						  <input class="form-check-input" type="radio" name="food_type" id="food_type" value="素" required>
						  <label class="form-check-label">素</label>
					  </div>
				  </div>
				</div>
				<div class="mb-3 col-12">
					<label class="form-label">價錢</label>
			 		<input type="number" class="form-control" min="0" max="9999999999" name="price" id="price" required>
				</div>
				<div class="mb-3 col-12">
					  <label class="form-label">描述1</label>
					  <input type="text" class="form-control" name="description1" required>
				</div>
				<div id="newFields"></div>
				<div class="text-center">
				  <button type="button" class="btn btn-light" onclick="window.location.href='/food'">取消</button>
				  <button type="submit" class="btn btn-primary">新增</button>
				</div>
				</form>
			</div>
	</div>
	</div>
	</div>
	</div>
	</div>
	<%- include('../sos') %>
	<script src = 'https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js' ></script>
	<script>
		let fieldCounter = 2;
		let fieldNum = 2;
		function addField() {
			const newFields = document.getElementById("newFields");
			// 新增一個欄位
			var newDiv = document.createElement('div');
			newDiv.id = `field${fieldCounter}`;
			newDiv.className = 'mb-3 col-12';
			var newLabel = document.createElement('label');
			newLabel.id = `des${fieldCounter}`;
			newLabel.className = 'form-label';
			newLabel.textContent = `描述${fieldNum}`;
			var newDiv1 = document.createElement('div');
			newDiv1.className = 'input-group';
			var newInput = document.createElement('input');
			newInput.type = 'text';
			newInput.className = 'form-control';
			newInput.name = `description${fieldCounter}`;
			newInput.required = true;
			var deleteButton = document.createElement('button');
			deleteButton.type = 'button';
			deleteButton.className = 'ms-2 btn btn-danger';
			deleteButton.textContent = '刪除';
			const now_id = fieldCounter;
			deleteButton.onclick = function() {
				removeField(now_id);
			};
			newDiv1.appendChild(newInput);
			newDiv1.appendChild(deleteButton);
			newDiv.appendChild(newLabel);
			newDiv.appendChild(newDiv1);
			newFields.appendChild(newDiv);
			fieldCounter++;
			fieldNum++;
		}
		function removeField(id) {
			fieldNum -= 1;
			document.getElementById("field"+id).remove();
			var desInput = document.getElementsByTagName("label");
			new_id = 2;
			for (let i = 0; i < desInput.length; i++) {
				var desId = desInput[i].getAttribute("id");
				if (desId && desId.startsWith("des")) {
					desInput[i].textContent = `描述${new_id}`;
					new_id++;
				}
			}
		}
		document.getElementById("foodForm").addEventListener("submit", function(event) {
			event.preventDefault();
			
			const formData = new FormData(document.getElementById("foodForm"));
			// 將新增的欄位資料加入 FormData 物件
			const newFields = document.getElementById("newFields");
			const newInputs = newFields.querySelectorAll('input');
			newInputs.forEach(input => {
				console.log(input);
				formData.append(input.name, input.value);
			});

			const jsonData = {};
			formData.forEach((value, key) => {
				jsonData[key] = value;
			});
			axios.post('/food/create',jsonData)
				.then(res => {
					if (res.data.suc == true) {
						alert('成功新增菜色！');
						window.location.href='/food';
					} else {
						alert('登入驗證失敗，請重新登入！');
						window.location.href='/login';
					}
				})
				.catch(error => {
					console.error(error);
				});
		});
	</script>
</body>
</html>
